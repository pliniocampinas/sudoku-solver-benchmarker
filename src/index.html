<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sudoku Benchmarker</title>
</head>
<style>
  .results {
    width: 300px;
  }

  .run-button {
    width: 100%;
  }

  .results textarea {
    width: 100%;
    height: 52px;
  }

  td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }

  tr:nth-child(even) {
    background-color: #dddddd;
  }

  .mb-1 {
    margin-bottom: 10px;
  }
</style>
<body>
  <h1>Sudoku Benchmarker</h1>
  <div class="results">
    <label for="sudoku-line-input">Sudoku Line:</label>
    <textarea class="mb-1" id="sudoku-line-input"></textarea>
    <label for="request-repeat">Request Repeat Number:</label>
    <input class="mb-1" id="request-repeat" type="number">
    <button class="run-button">Run Benchmarker</button>
    <p>Results:</p>
    <table id="results-table">
      <thead>
        <tr>
          <th>API</th>
          <th>Path</th>
          <th>ms</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</body>
<script>
  const apis = [
    {
      label: 'Rust Crate Api',
      name: 'rust-crate-api',
      path: 'http://127.0.0.1:8080/solve'
    },
    {
      label: 'Node Handmade Api',
      name: 'node-handmade-api',
      path: 'http://127.0.0.1:8125/solve'
    },
  ];
  const initialSudokuLine = '...2...633....54.1..1..398........9....538....3........263..5..5.37....847...1...';
  const sudokuLineSelector = '#sudoku-line-input';
  const getSudokuLine = () => document.querySelector(sudokuLineSelector)?.textContent
  const setSudokuLine = (newValue) => document.querySelector(sudokuLineSelector).textContent = newValue

  const initialRepeatNumber = 100;
  const repeatNumberSelector = '#request-repeat';
  const getRepeatNumber = () => document.querySelector(repeatNumberSelector)?.value
  const setRepeatNumber = (newValue) => document.querySelector(repeatNumberSelector).value = newValue

  const setResultTime = (api, time) => {
    const durationCellSelector = `#${api.name}-duration`;
    document.querySelector(durationCellSelector).textContent = time;
  }

  const fetchResult = async ({path}) => {
    const result = await fetch(`${path}/${getSudokuLine()}`).then(res => res.text())
  }

  const getResultRowHtml = ({label, name, path, msDuration}) => `
    <td>${label}</td>
    <td>${path}</td>
    <td id=${name}-duration>${msDuration || "-"}</td>
  `;

  const initTable = () => {
    const tBodyRef = document.querySelector('#results-table tbody')
    apis.forEach(api => {
      const rowElement = document.createElement('tr');
      rowElement.innerHTML = getResultRowHtml(api);
      tBodyRef.appendChild(rowElement)
    })
  }

  const logDuration = (api, ms) => {
    console.log(`Api[${api.name}] - Execution time[${ms}ms]`);
  }

  const runBenchmark = () => {
    console.log('Fetching...')
    apis.forEach(async (api) => {
      const start = new Date().getTime();

      for (i = 0; i < getRepeatNumber(); ++i) {
        await fetchResult(api)
      }

      const end = new Date().getTime();
      const time = end - start;
      logDuration(api, time);
      setResultTime(api, time);
    })
  }

  window.addEventListener('load', () => {
    setSudokuLine(initialSudokuLine)
    setRepeatNumber(initialRepeatNumber)
    initTable();
    document.querySelector('.run-button').addEventListener('click', runBenchmark);
  });
</script>
</html>